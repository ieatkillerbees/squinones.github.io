<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Pushing Bamboo Notifications to Datadog</title>
	
	<meta name="author" content="Samantha QuiÃ±ones">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/squinones">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/ieatkillerbees">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:samantha@tembies.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="assets/media/b4panel.png" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/calendar.html">Calendar</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/media/b4panel.png" class="img-circle" />
		<!-- <img src="http://www.gravatar.com/avatar/24368af16c4b0946ece77da839b7b53a?s=150" class="img-circle" /> -->
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	PHP & Python hacker, lead engineer @POLITICO
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/squinones">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/ieatkillerbees">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/samanthaquinones">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:samantha@tembies.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<div>
	<ul id="twitter-widget" class="list-unstyled">
		<a class="twitter-timeline" href="https://twitter.com/ieatkillerbees" data-widget-id="510951210841427968">Tweets by @ieatkillerbees</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	</ul>
</ul>
</div>
<! -- sidebar.html end -->

	</div>
	<div class="col-sm-9 navbar col-sm-offset-3 hidden-xs" id="navbar">
		<ul role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/calendar.html"><i class="fa fa-calendar">Calendar</i></a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
		</ul>
	</div>

	<div class="col-sm-9 content-body col-sm-offset-3">
		<div class="page-header">
  <h1>Pushing Bamboo Notifications to Datadog </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   June 
	   27th,
	   
	   2013
	 </span>
	  <div class="article_body">
	  <p>In my last post, I mentioned that where I work, we settled on Bamboo as our continuous integration solution. I love Bamboo, but its built-in notification features are pretty lacking. In fact, your only options out of the box are XMPP messaging (with no conferencing, so meh) or email (yech).</p>

<h2 id="i-3-datadog">I &lt;3 Datadog</h2>

<p style="text-align: center;"><a href="http://datadoghq.com"><img class="aligncenter" alt="" src="assets/dd_logo_white_trim-300.png" width="300" height="62" /></a></p>

<p>Another tool we use at <a href="http://politico.com" target="_blank">Politico</a> is <a href="http://datadoghq.com" target="_blank">Datadog</a>. If you're not familiar with it, Datadog is an amazing hosted devops tool that combines rich visualization of metrics data with very nifty event streams and quasi-social groupwarish features. Datadog is changing how devs and system admins work in our environment, and we're increasingly looking for ways that it can make our lives better.</p>
<p>Datadog is our central event management platform, and having our build events there cuts Bamboo off from the rest of our notification pipeline, and that's just the pits. Over the past day or two, the Politico Tech Lab has been abuzz with increasingly Rube-Goldbergian ideas for how to solve what boils down to a very simple problem: how do we push a tiny blob of text across the Internet. Eventually we came to the idea of setting up an XMPP server that both Bamboo and our IRC bot could long in to, with the goal of teaching the IRC bot to forward messages to Datadog's API. Yeah, silly.</p>
<p>Then, suddenly, the clouds parted and the heavenly chorus picked up and the solution presented itself as clear as crystal: python.</p>
<h2>Python to the Rescue</h2>
<p>Python's standard library includes a simple, but very functional SMTP server implementation. Yeah, that's right, we built a mail server.</p>
<p>The code's very short, but we can take a quick tour.</p>
<pre>import asyncore
import email
import socket
from dogapi import dog_http_api as api
from smtpd import SMTPServer</pre>
<p>We'll need the basic asynchronous socket server module, email (to tame Bamboo's HTML mishmash), the socket module, the basic SMTPServer module from smtpd, and Datadog's API, which is available from the cheese shop with a simple 'pip install dogapi'.</p>
<pre>class Server(SMTPServer):
    def __init__(self, dd_api_keys, host="127.0.0.1", port=4242):
        self.dd_api_keys = dd_api_keys
        asyncore.dispatcher.__init__(self)
        self.create_socket(socket.AF_INET, socket.SOCK_STREAM)
        self.set_reuse_addr()
        self.bind((host, port))
        self.listen(5)</pre>
<p>Now we just have to extend the SMTPServer class. We'll need to take in some datadog api keys (as a tuple, in this case), as well as an address to bind to and a port to listen on. SMTPServer itself extends asyncore.dispatcher, so we need to init correctly before setting up a socket to listen on.</p>
<pre>    def process_message(self, peer, sender, recipients, body):
        api_key, app_key = self.dd_api_keys

        message = email.message_from_string(data)
        title   = " ".join(self.message["subject"].split("\n"))
        text    = message.get_payload(0)

        api.event(title, text)</pre>
<p>The method 'process_message' will be called any time a mail client delivers a message to our server for delivery. We'll get information about the peer as a standard (addr,port) tuple, the sender's address as a string, a list of recipient email addresses, and the message body also as a string.</p>
<p>At this point, we go ahead and unpack those api keys. The python email module will break up the raw email message enough to make things simpler. We can easily grab the subject to use as our event title. Bamboo sends multipart messages with the plaintext body in the first part, so we just use get_payload to pull out the 0th index.</p>
<p>Calling api.event will fire the event off to Datadog.</p>
<pre>if __name__ == '__main__':
    apikey = 
    appkey = 
    server = Server((apikey, appkey))
    asyncore.loop()</pre>
<p>And last, we instantiate our server and start our little server up.</p>
<h2>Wrapping it Up</h2>
<p>In our actual implementation, we ended up massaging this data a bit more to clean things up and make the events conform more to our own internal needs and desires. This code is what remains after that stuff has been chopped out, so NB, I haven't even attempted to execute it and may not run as is. It should be enough to get you started on your own sneaky little SMTP server</p>
<p>&nbsp;</p>
<h2>Further Reading</h2>
<ul>
<li><a href="http://datadoghq.com" target="_blank"><span style="line-height: 13px;">Check out Datadog's website and free trial. Seriously, these guys are awesome!</span></a></li>
<li><a href="https://gist.github.com/squinones/5881996">Grab the (possibly) working code!</a></li>
</ul>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#devops-ref">
					devops <span>(2)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#continuous integration-ref">
					continuous integration <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#datadog-ref">
					datadog <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#devops-ref">
					devops <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#dirty hacks-ref">
					dirty hacks <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#python-ref">
					python <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Pushing Bamboo Notifications to Datadog&via=ieatkillerbees"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/24368af16c4b0946ece77da839b7b53a" class="img-rounded author-image" />
        <h4 class="section-title author-name">Samantha QuiÃ±ones</h4>
        <p class="author-bio">PHP & Python hacker, lead engineer @POLITICO</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/devops/2013/06/12/continuous-integration-deployment-with-php.html" title="Why you should consider Continuous Integration">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/2013/09/12/speaking-ski-php-jan-17th-18th-2013.html" title="Speaking at Ski PHP, Jan 17th & 18th, 2013">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



		<footer>
			<hr/>
			<p>
				&copy; 2014 Samantha QuiÃ±ones with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/calendar.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-39817287-1', 'auto');
	  ga('send', 'pageview');

	</script>
	
</body>
</html>

